<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>session</title>
  <link rel="stylesheet" href="/static/style.css" type="text/css" />
</head>

<body>

  <input id="ticket-id" placeholder="new ticket id" />
  <button id="add-ticket">add a new ticket</button>
  <div id="users"></div>
  <div id="list"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    var socket = io();
    var sessionObject = {};
    var types = { complexity: 'complexity', time: 'time' };
    var subtasks = [{
      title: 'Complexity',
      type: types.complexity,
      id: 'complexity'
    }, {
      title: 'Spec',
      type: types.time,
      id: 'ba'
    }, {
      title: 'tests',
      type: types.time,
      id: 'tests'
    }, {
      title: 'dev back',
      type: types.time,
      id: 'backend'
    }, {
      title: 'dev front',
      type: types.time,
      id: 'frontend'
    }]


    var [sessionId, userName] = window.location.pathname.split('/').slice(-2);
    socket.emit('join room', sessionId, userName);

    var list = document.getElementById('list');
    socket.on('changed', session => {
      constructList(session);
    });
    var addTicketButton = document.getElementById('add-ticket');
    addTicketButton.onclick = () => {
      var input = document.getElementById('ticket-id');
      if (input.value) {
        socket.emit('new ticket', sessionId, input.value, userName);
      }
    }

    socket.on('all noted', ticket => {
      const contentElement = document.getElementById(`${ticket.ticketName}-content`);
      contentElement.innerHTML = "";
      constructNotesTable(ticket, true);
    });

    socket.on('validated', ticket => {
      const contentElement = document.getElementById(`${ticket.ticketName}-content`);
      contentElement.innerHTML = "";
      constructNotesTable(ticket, false);
      constructNotesValidated(ticket);
    });

    socket.on('user joined', constructUsersList);
    socket.on('user left', constructUsersList);

    function constructComplexityInput() {
      var selectElement = document.createElement("select");
      var optPH = document.createElement("option");
      var opt1 = document.createElement("option");
      var opt2 = document.createElement("option");
      var opt3 = document.createElement("option");
      var opt5 = document.createElement("option");
      var opt8 = document.createElement("option");
      var opt13 = document.createElement("option");
      var optInfinity = document.createElement("option");

      optPH.text = 'Choose complexity';
      optPH.value = "";
      opt1.value = 1;
      opt1.text = "1";
      opt2.value = 2;
      opt2.text = "2";
      opt3.value = 3;
      opt3.text = "3";
      opt5.value = 5;
      opt5.text = "5";
      opt8.value = 8;
      opt8.text = "8";
      opt13.value = 13;
      opt13.text = "13";
      optInfinity.value = Infinity;
      optInfinity.text = "Infinity";
      selectElement.add(optPH);
      selectElement.add(opt1);
      selectElement.add(opt2);
      selectElement.add(opt3);
      selectElement.add(opt5);
      selectElement.add(opt8);
      selectElement.add(opt13);
      selectElement.add(optInfinity);
      return selectElement;
    }

    function constructInputLine(title, values, idPrefix) {
      const lineElement = document.createElement('tr');
      lineElement.id = idPrefix;
      if (title) {
        const titleElement = document.createElement('td');
        titleElement.innerText = title;
        lineElement.appendChild(titleElement);
      }

      subtasks.forEach(({ id, type, title }) => {
        const el = document.createElement('td');
        if (type === types.complexity) {
          const inputElement = constructComplexityInput();
          inputElement.id = `${idPrefix}-${id}`;
          inputElement.value = values && values[id] || '';
          inputElement.placeholder = title;
          el.appendChild(inputElement);
        } else {
          const inputElement = document.createElement('input');
          inputElement.id = `${idPrefix}-${id}`;
          inputElement.value = values && values[id] || '';
          inputElement.placeholder = title;
          el.appendChild(inputElement);
        }
        lineElement.appendChild(el);
      });
      return lineElement;
    }

    function constructLine(title, values, idPrefix) {
      const lineElement = document.createElement('tr');
      lineElement.id = title;
      const titleElement = document.createElement('td');
      titleElement.innerText = title;
      lineElement.appendChild(titleElement);

      subtasks.forEach(({ id, type }) => {
        const el = document.createElement('td');
        el.id = idPrefix + id;
        el.innerText = values[id];
        lineElement.appendChild(el);
      });
      return lineElement;
    }

    function constructUsersList(users) {
      const usersElement = document.getElementById("users");
      usersElement.innerText = users.join(', ');
    }

    function constructNotesTable(ticket, toValidate) {
      const ticketElement = document.getElementById(`${ticket.ticketName}-content`);
      let tableElement = document.getElementById(`${ticket.ticketName}-table`);

      const average = subtasks.map(({ title, id, type }) => {
        if (type === types.complexity) {
          return {
            id,
            note: Object.values(ticket.notes).reduce(((acc, note) =>
              !isNaN(parseFloat(note[id], 10))
                ? Math.max(note[id], acc) : acc), 0),
          };
        } else if (type === types.time) {
          return {
            id,
            note: Object.values(ticket.notes).reduce(((acc, note) =>
              !isNaN(parseFloat(note[id], 10))
                ? acc + parseFloat(note[id], 10) : acc), 0) / Object
                  .values(ticket.notes)
                  .filter(note => !isNaN(parseFloat(note[id], 10))).length,
          };
        } else {
          return {
            id,
            note: null
          };
        }
      }).reduce((acc, av) => ({
        ...acc,
        [av.id]: av.note,
      }), {});

      if (!tableElement) {
        tableElement = document.createElement('table');
        tableElement.id = `${ticket.ticketName}-table`;
      } else {
        tableElement.innerHTML = '';
      }
      const lineElement = document.createElement('tr');
      lineElement.id = 'titres';
      const nickNameElement = document.createElement('th');
      nickNameElement.innerText = 'NickName';
      lineElement.appendChild(nickNameElement);

      subtasks.forEach(({ id, title }) => {
        const titleElement = document.createElement('th');
        titleElement.innerText = title;
        lineElement.appendChild(titleElement);
      });

      tableElement.appendChild(lineElement);
      Object.keys(ticket.notes).forEach(nickName => {
        const notes = ticket.notes[nickName];
        const lineElement = document.createElement('tr');
        lineElement.id = nickName;
        const nickNameElement = document.createElement('td');
        nickNameElement.innerText = nickName;
        lineElement.appendChild(nickNameElement);
        subtasks.forEach(({ id }) => {
          const el = document.createElement('td');
          el.innerText = notes[id];
          lineElement.appendChild(el);
        });
        tableElement.appendChild(lineElement);
      });

      ticketElement.appendChild(tableElement);

      const lineAverageElement = userName === ticket.admin && toValidate
        ? constructInputLine('average', average, `${ticket.ticketName}-proposed`)
        : constructLine('average', average, `${ticket.ticketName}-proposed`);

      tableElement.appendChild(lineAverageElement);

      if (userName === ticket.admin && toValidate) {
        if (!document.getElementById(`${ticket.ticketName}-button-validate`)) {
          var validateRatingButton = document.createElement('button');
          validateRatingButton.id = `${ticket.ticketName}-button-validate`;
          validateRatingButton.innerHTML = "Validate notes";
        }
        validateRatingButton.onclick = () => {
          const notes = subtasks.reduce((acc, { id }) => ({
            ...acc,
            [id]: document.getElementById(`${ticket.ticketName}-proposed-${id}`).value
          }), {});
          socket.emit('validate notes', sessionId, ticket.ticketName, notes);
        };
        ticketElement.appendChild(validateRatingButton);
      }
    }

    function constructNotesValidated(ticket) {
      const summaryElement = document.getElementById(`${ticket.ticketName}-summary`);
      summaryElement.innerHTML = Object.keys(ticket.validatedNotes)
        .reduce(
          (acc, key) =>
            `${acc} <span><b>${key}:</b> ${ticket.validatedNotes[key]}${
            subtasks.find(({ id, type }) => id === key && type === types.time) ? 'h' : ''
            }</span>`
          , '');
    }

    function constructList(session) {
      list.innerHTML = '';
      session.tickets.map((ticket, index) => {
        var ticketElement = document.createElement('details');
        ticketElement.id = ticket.ticketName;
        ticketElement.open = ticket.status !== 'validated';
        var summary = document.createElement('summary');
        summary.innerText = ticket.ticketName;
        const summaryNotes = document.createElement('div');
        summaryNotes.id = `${ticket.ticketName}-summary`;
        summary.appendChild(summaryNotes);
        if (userName === ticket.admin && ticket.status === 'inProgress') {
          const stopNotation = document.createElement('button');
          stopNotation.innerText = 'Stop notation';
          stopNotation.style.margin = '0.2rem';
          stopNotation.onclick = event => {
            socket.emit('force stop notation', sessionId, ticket.ticketName);
            event.target.style.display = "none";
          };
          summaryNotes.appendChild(stopNotation);
        }

        ticketElement.appendChild(summary);
        var content = document.createElement('div');
        content.id = `${ticket.ticketName}-content`;
        content.className = "ticket-content";
        ticketElement.appendChild(content);

        list.appendChild(ticketElement);
        if (ticket.status === 'inProgress') {
          content.appendChild(
            constructInputLine(undefined, ticket.notes[userName], ticket.ticketName)
          );

          var validateRatingButton = document.createElement('button');
          validateRatingButton.innerHTML = "Propose notes";
          validateRatingButton.onclick = (event) => {
            var notes = {
              complexity: document.getElementById(`${ticket.ticketName}-complexity`).value,
              ba: document.getElementById(`${ticket.ticketName}-ba`).value,
              backend: document.getElementById(`${ticket.ticketName}-backend`).value,
              frontend: document.getElementById(`${ticket.ticketName}-frontend`).value,
              tests: document.getElementById(`${ticket.ticketName}-tests`).value,
            }
            socket.emit('add notes', sessionId, ticket.ticketName, userName, notes)
          }
          content.appendChild(validateRatingButton);
        }
        else if (ticket.status === 'allNoted') {
          constructNotesTable(ticket, true)
        } else if (ticket.status === 'validated') {
          constructNotesTable(ticket, false)
          constructNotesValidated(ticket);
        }
      })
    }
    if (sessionId) {
      fetch('/api/session/' + sessionId)
        .then(resp => resp.json())
        .then(({ session }) => {
          sessionObject = session;
          if (!session) window.location.assign('/');
          constructList(session);
        });
    }
  </script>
</body>

</html>