<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>session</title>
  <link rel="stylesheet" href="/static/style.css" type="text/css" />
</head>

<body>
  <input id="ticket-id" class="input" placeholder="new ticket id" />
  <button id="add-ticket" class="button">add a new ticket</button>
  <div class="copy-container">
    <span id="share-session-text" class="to-copy-text"></span>
    <button onclick="copySessionToClipboard(this)">Copy session</button>
  </div>
  <div id="users"></div>
  <div id="list"></div>
  <script src="/socket.io/socket.io.js"></script>

  <script src="/static/construct.js"></script>
  <script>
    var socket = io();
    var sessionObject = {};
    var types = { complexity: 'complexity', time: 'time' };
    var subtasks = [{
      title: 'Complexity',
      type: types.complexity,
      id: 'complexity'
    }, {
      title: 'Spec',
      type: types.time,
      id: 'ba'
    }, {
      title: 'tests',
      type: types.time,
      id: 'tests'
    }, {
      title: 'dev back',
      type: types.time,
      id: 'backend'
    }, {
      title: 'dev front',
      type: types.time,
      id: 'frontend'
    }];

    const textToCopy = document.getElementById("share-session-text");
    textToCopy.innerText = window.location.href.split('/').slice(0, -1).join('/');

    // function copySessionToClipboard() {
    //   copyText.select();
    //   copyText.setSelectionRange(0, 99999); /*For mobile devices*/

    //   document.execCommand("copy");
    //   /* Alert the copied text */
    //   alert("Copied the text: " + copyText.value);
    // }

    function copySessionToClipboard(target) {
      //check and see if the user had a text selection range
      let currentRange;
      if (document.getSelection().rangeCount > 0) {
        //the user has a text selection range, store it
        currentRange = document.getSelection().getRangeAt(0);
        //remove the current selection
        window.getSelection().removeRange(currentRange);
      } else {
        //they didn't have anything selected
        currentRange = false;
      }
      //create a selection range
      const CopyRange = document.createRange();
      //choose the element we want to select the text of
      CopyRange.selectNode(textToCopy);
      //select the text inside the range
      window.getSelection().addRange(CopyRange);
      //copy the text to the clipboard
      document.execCommand("copy");
      target.innerText = 'âœ“';
      setTimeout(() => target.innerText = 'Copy session', 5000)

      //remove our selection range
      window.getSelection().removeRange(CopyRange);

      //return the old selection range
      if (currentRange) {
        window.getSelection().addRange(currentRange);
      }
    }


    var [sessionId, userName] = window.location.pathname.split('/').slice(-2);
    socket.emit('join room', sessionId, userName);

    var list = document.getElementById('list');
    socket.on('changed', session => {
      constructList(session);
    });
    var addTicketButton = document.getElementById('add-ticket');
    addTicketButton.onclick = () => {
      var input = document.getElementById('ticket-id');
      if (input.value) {
        socket.emit('new ticket', sessionId, input.value, userName);
      }
    }

    socket.on('all noted', ticket => {
      const contentElement = document.getElementById(`${ticket.ticketName}-content`);
      const stopNotationElement = document.getElementById('stopNotation');
      stopNotationElement && stopNotationElement.parentNode.removeChild(stopNotationElement);

      contentElement.innerHTML = "";
      contentElement.appendChild(constructAllNotedTicket(ticket));
    });

    socket.on('user noted', ({ ticketName, userName }) => {
      const rowElement = document.getElementById(`${ticketName}-${userName}-note`);
      rowElement.innerHTML = "";
      rowElement.appendChild(
        constructWaitingForResponsesList(
          userName, true, `${ticketName}-${userName}-note`
        )
      );
    });

    socket.on('validated', ticket => {
      const contentElement = document.getElementById(`${ticket.ticketName}-content`);
      const summaryNotes = document.getElementById(`${ticket.ticketName}-summary`);

      contentElement.innerHTML = "";
      contentElement.appendChild(constructValidatedTicket(ticket));
      summaryNotes.innerHTML = getSummaryNotes(ticket);
    });

    socket.on('user joined', constructUsersList);
    socket.on('user left', constructUsersList);

    function constructList(session) {
      list.innerHTML = '';
      session.tickets.forEach((ticket, index) => {
        var ticketElement = document.createElement('details');
        ticketElement.id = ticket.ticketName;
        ticketElement.open = ticket.status !== 'validated';
        const summary = constructTicketHeader(ticket);

        ticketElement.appendChild(summary);
        var content = document.createElement('div');
        content.id = `${ticket.ticketName}-content`;
        content.className = "ticket-content";
        ticketElement.appendChild(content);

        switch (ticket.status) {
          case 'inProgress':
            content.appendChild(constructInProgressTicket(ticket));
            break;
          case 'allNoted':
            content.appendChild(constructAllNotedTicket(ticket));
            break;
          case 'validated':
            content.appendChild(constructValidatedTicket(ticket));
            break;
        }

        list.insertBefore(ticketElement, list.childNodes[0]);
      });
    }

    if (sessionId) {
      fetch('/api/session/' + sessionId)
        .then(resp => resp.json())
        .then(({ session }) => {
          sessionObject = session;
          if (!session) window.location.assign('/');
          constructList(session);
        });
    }
  </script>
</body>

</html>